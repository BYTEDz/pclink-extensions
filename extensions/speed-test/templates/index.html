<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Speed Test</title>
    <script src="/ui/static/extension-theme.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html,
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background: var(--bg);
            color: var(--text);
            overflow-x: hidden;
            overflow-y: auto;
        }

        body {
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .header {
            width: 100%;
            text-align: center;
        }

        .brand {
            font-weight: 900;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 4px;
            color: var(--primary);
            margin-bottom: 12px;
        }

        .tabs {
            display: flex;
            background: var(--surface);
            padding: 4px;
            border-radius: 14px;
            width: 100%;
            max-width: 320px;
            border: var(--card-border);
        }

        .tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            font-size: 13px;
            font-weight: 700;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: 11px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .tab.active {
            background: var(--primary);
            color: var(--on-primary);
            box-shadow: 0 4px 12px var(--primary-muted);
        }

        /* SVG GAUGE */
        .gauge-container {
            position: relative;
            width: 240px;
            height: 160px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .gauge-svg {
            transform: rotate(-220deg);
            width: 240px;
            height: 240px;
            position: absolute;
            top: -20px;
        }

        .gauge-track {
            fill: none;
            stroke: var(--surface);
            stroke-width: 14;
            stroke-linecap: round;
            stroke-dasharray: 440;
            stroke-dashoffset: 176;
        }

        .gauge-fill {
            fill: none;
            stroke: var(--primary);
            stroke-width: 14;
            stroke-linecap: round;
            stroke-dasharray: 440;
            stroke-dashoffset: 440;
            transition: stroke-dashoffset 0.8s cubic-bezier(0.22, 1, 0.36, 1);
            filter: drop-shadow(0 0 10px var(--primary-muted));
        }

        .gauge-content {
            z-index: 10;
            text-align: center;
            margin-top: 45px;
        }

        .speed-number {
            font-size: 58px;
            font-weight: 900;
            margin: 0;
            line-height: 1;
            font-family: 'JetBrains Mono', monospace;
            letter-spacing: -2px;
        }

        .speed-unit {
            font-size: 14px;
            color: var(--text-muted);
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 3px;
            margin-top: 4px;
        }

        .main-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            width: 100%;
            max-width: 400px;
        }

        .stat-card {
            background: var(--surface);
            padding: 16px;
            border-radius: var(--radius);
            border: var(--card-border);
            text-align: center;
            box-shadow: var(--card-shadow);
        }

        .stat-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 6px;
            font-weight: 800;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 800;
            color: var(--text);
        }

        .stat-unit {
            font-size: 10px;
            color: var(--text-muted);
            margin-left: 2px;
        }

        .history-section {
            width: 100%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .history-title {
            font-size: 12px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 8px;
        }

        .history-card {
            background: var(--surface);
            border-radius: var(--radius);
            border: var(--card-border);
            padding: 14px;
            display: grid;
            grid-template-columns: auto 1fr auto;
            align-items: center;
            gap: 12px;
            opacity: 0.9;
        }

        .history-icon {
            width: 32px;
            height: 32px;
            background: var(--primary-faint);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
        }

        .history-info {
            display: flex;
            flex-direction: column;
        }

        .history-date {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
        }

        .history-type {
            font-size: 13px;
            font-weight: 800;
            text-transform: capitalize;
        }

        .history-speeds {
            text-align: right;
            font-weight: 800;
            font-size: 14px;
        }

        .history-ping {
            font-size: 10px;
            color: var(--success);
            font-weight: 600;
        }

        .btn-start {
            width: 100%;
            max-width: 400px;
            padding: 18px;
            background: var(--primary);
            color: var(--on-primary);
            border: none;
            border-radius: var(--radius);
            font-size: 16px;
            font-weight: 900;
            cursor: pointer;
            box-shadow: 0 8px 16px var(--primary-muted);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .btn-start:active:not(:disabled) {
            transform: scale(0.96);
        }

        .btn-start:disabled {
            background: var(--surface);
            color: var(--text-muted);
            box-shadow: none;
            opacity: 0.6;
        }

        .status-badge {
            font-size: 11px;
            font-weight: 800;
            padding: 4px 14px;
            border-radius: 20px;
            background: var(--hover-overlay);
            color: var(--text-muted);
            border: 1px solid var(--divider);
            text-transform: uppercase;
        }

        #appLoader {
            position: fixed;
            inset: 0;
            background: var(--bg);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .testing .gauge-fill {
            animation: pulse-glow 2s infinite ease-in-out;
        }

        @keyframes pulse-glow {

            0%,
            100% {
                stroke-opacity: 0.8;
                filter: drop-shadow(0 0 5px var(--primary-muted));
            }

            50% {
                stroke-opacity: 1;
                filter: drop-shadow(0 0 15px var(--primary));
            }
        }

        .hidden {
            display: none !important;
        }

        /* Mobile Scrollbar hiding */
        ::-webkit-scrollbar {
            width: 0;
            background: transparent;
        }
    </style>
</head>

<body id="body">
    <div id="appLoader">
        <div
            style="width: 40px; height: 40px; border: 4px solid var(--primary-faint); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite;">
        </div>
    </div>

    <div class="header">
        <div class="brand">Network Engine</div>
        <div id="statusBadge" class="status-badge">Engine Ready</div>
    </div>

    <div class="tabs">
        <div class="tab active" id="tabInternet" onclick="setMode('internet')">Broadband</div>
        <div class="tab" id="tabLan" onclick="setMode('lan')">Local Link</div>
    </div>

    <div class="gauge-container">
        <svg class="gauge-svg" viewBox="0 0 200 200">
            <circle class="gauge-track" cx="100" cy="100" r="70" />
            <circle class="gauge-fill" id="gaugeFill" cx="100" cy="100" r="70" />
        </svg>
        <div class="gauge-content">
            <div class="speed-number" id="mainSpeed">0.0</div>
            <div class="speed-unit" id="mainUnit">Mbps</div>
        </div>
    </div>

    <div class="main-stats">
        <div class="stat-card">
            <div class="stat-label">Download</div>
            <div class="stat-value" id="dlDisplay">0.0 <span class="stat-unit">Mbps</span></div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Upload</div>
            <div class="stat-value" id="ulDisplay">0.0 <span class="stat-unit">Mbps</span></div>
        </div>
    </div>

    <div class="history-section">
        <div class="history-title">
            <i data-lucide="history" style="width: 14px;"></i>
            Recent Results
        </div>
        <div id="historyList" style="display: flex; flex-direction: column; gap: 8px;">
            <!-- History entries -->
        </div>
    </div>

    <button id="startBtn" class="btn-start" onclick="startTest()">
        <i data-lucide="play"></i>
        <span>INITIATE TEST</span>
    </button>

    <script>
        lucide.createIcons();
        const apiPath = window.location.pathname.replace(/\/ui$/, '');
        let isTesting = false;
        let currentMode = 'internet';

        // History Storage
        let testHistory = JSON.parse(localStorage.getItem('pclink_speed_history') || '[]');

        function formatSpeed(mbps) {
            if (mbps >= 1000) {
                return { value: (mbps / 1000).toFixed(2), unit: "Gbps" };
            }
            return { value: mbps.toFixed(1), unit: "Mbps" };
        }

        function setMode(mode) {
            if (isTesting) return;
            currentMode = mode;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(mode === 'internet' ? 'tabInternet' : 'tabLan').classList.add('active');
            updateStatus('Engine Ready');
        }

        function updateGauge(speed) {
            const maxRef = 1000; // 1Gbps ref
            const circlePerimeter = 2 * Math.PI * 70;
            const visibleArc = 0.61;
            const minOffset = circlePerimeter * (1 - visibleArc);

            const percent = Math.min(speed / maxRef, 1);
            const offset = circlePerimeter - (percent * (circlePerimeter - minOffset));
            document.getElementById('gaugeFill').style.strokeDashoffset = offset;
        }

        function updateHistory(entry) {
            testHistory.unshift(entry);
            if (testHistory.length > 5) testHistory.pop();
            localStorage.setItem('pclink_speed_history', JSON.stringify(testHistory));
            renderHistory();
        }

        function renderHistory() {
            const container = document.getElementById('historyList');
            if (testHistory.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-muted); font-size: 11px; padding: 20px;">No recent tests</div>';
                return;
            }
            container.innerHTML = testHistory.map(h => {
                const dl = formatSpeed(h.download);
                const ul = formatSpeed(h.upload);
                const date = new Date(h.timestamp * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const icon = h.mode === 'internet' ? 'globe' : 'wifi';
                return `
                    <div class="history-card">
                        <div class="history-icon"><i data-lucide="${icon}" style="width: 16px;"></i></div>
                        <div class="history-info">
                            <div class="history-type">${h.mode} Test</div>
                            <div class="history-date">${date} • ${h.ping}ms</div>
                        </div>
                        <div class="history-speeds">
                            <div>${dl.value} <span style="font-size: 9px; color: var(--text-muted)">${dl.unit} ↓</span></div>
                            <div style="font-size: 11px; opacity: 0.7;">${ul.value} <span style="font-size: 9px; color: var(--text-muted)">${ul.unit} ↑</span></div>
                        </div>
                    </div>
                `;
            }).join('');
            lucide.createIcons();
        }

        async function startTest() {
            if (currentMode === 'internet') {
                const res = await fetch(apiPath + '/start', { method: 'POST' });
                if ((await res.json()).status === 'success') {
                    isTesting = true;
                    updateUI();
                }
            } else {
                startLanTest();
            }
        }

        async function startLanTest() {
            isTesting = true;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('body').classList.add('testing');
            let maxMeasured = 0;

            try {
                updateStatus('LATENCY...');
                const startPing = Date.now();
                await fetch(apiPath + '/status');
                const pingVal = Date.now() - startPing;

                updateStatus('DOWNLOADING...');
                const dlRes = await fetch(apiPath + '/local/download');
                const reader = dlRes.body.getReader();
                let received = 0;
                const startDl = Date.now();
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    received += value.length;
                    const elapsed = (Date.now() - startDl) / 1000;
                    const mbps = (received * 8) / (1024 * 1024) / elapsed;
                    refreshDisplay(mbps, 0);
                    if (mbps > maxMeasured) maxMeasured = mbps;
                }

                updateStatus('UPLOADING...');
                const uploadData = new Uint8Array(20 * 1024 * 1024);
                const startUl = Date.now();
                await fetch(apiPath + '/local/upload', { method: 'POST', body: uploadData });
                const elapsedUl = (Date.now() - startUl) / 1000;
                const uploadMbps = (uploadData.length * 8) / (1024 * 1024) / elapsedUl;
                if (uploadMbps > maxMeasured) maxMeasured = uploadMbps;

                const finalDl = maxMeasured;
                const finalUl = uploadMbps;

                refreshDisplay(finalDl, finalUl);
                updateHistory({ mode: 'lan', download: finalDl, upload: finalUl, ping: pingVal, timestamp: Date.now() / 1000 });

                await fetch(apiPath + '/local/results', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ download: finalDl, upload: finalUl, ping: pingVal })
                });

                isTesting = false;
                document.getElementById('startBtn').disabled = false;
                document.getElementById('body').classList.remove('testing');
                updateStatus('ENGINE READY');
            } catch (e) {
                updateStatus('LINK ERROR');
                isTesting = false;
                document.getElementById('startBtn').disabled = false;
                document.getElementById('body').classList.remove('testing');
            }
        }

        function refreshDisplay(dlMbps, ulMbps) {
            const activeSpeed = dlMbps > 0 ? dlMbps : ulMbps;
            const fActive = formatSpeed(activeSpeed);
            const fDl = formatSpeed(dlMbps);
            const fUl = formatSpeed(ulMbps);

            document.getElementById('mainSpeed').textContent = fActive.value;
            document.getElementById('mainUnit').textContent = fActive.unit;
            updateGauge(activeSpeed);

            document.getElementById('dlDisplay').innerHTML = `${fDl.value} <span class="stat-unit">${fDl.unit}</span>`;
            document.getElementById('ulDisplay').innerHTML = `${fUl.value} <span class="stat-unit">${fUl.unit}</span>`;
        }

        async function updateUI() {
            try {
                const res = await fetch(apiPath + '/status');
                const data = await res.json();

                if (data.status === 'testing') {
                    const current = (data.download > 0 ? data.download : data.upload);
                    refreshDisplay(data.download, data.upload);
                    updateStatus(data.phase || 'TESTING...');
                    document.getElementById('startBtn').disabled = true;
                    document.getElementById('body').classList.add('testing');
                } else if (data.status === 'complete') {
                    refreshDisplay(data.download, data.upload);
                    updateStatus('ENGINE READY');
                    document.getElementById('startBtn').disabled = false;
                    document.getElementById('body').classList.remove('testing');
                    if (isTesting) {
                        updateHistory({
                            mode: data.mode,
                            download: data.download,
                            upload: data.upload,
                            ping: data.ping,
                            timestamp: data.timestamp
                        });
                        isTesting = false;
                    }
                }

                if (isTesting) setTimeout(updateUI, 1000);
            } catch (e) { }
        }

        function updateStatus(text) {
            document.getElementById('statusBadge').textContent = text;
        }

        // Initialize display
        renderHistory();
        updateUI().then(() => {
            const loader = document.getElementById('appLoader');
            if (loader) {
                loader.style.opacity = '0';
                setTimeout(() => loader.remove(), 400);
            }
        });
    </script>
</body>

</html>